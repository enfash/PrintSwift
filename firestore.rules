
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      // User must have an admin role document. Email verification is not required for this dev environment.
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --- Default Security Rule (Deny All by Default) ---
    match /{path=**} {
        allow read, write: if false;
    }

    // --- Public Read Collections ---
    
    // Product Categories Collection
    match /product_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /product_categories {
      allow list: if true;
    }
    
    // Products Collection
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /products {
      allow list: if true;
    }
    
    // Promotions Collection
    match /promos/{promoId} {
        allow write: if isAdmin();
        allow read: if isAdmin() || resource.data.active == true;
    }
    match /promos {
      // Allow admins to list everything, but public users can only list *active* promos.
      allow list: if isAdmin() || request.query.where.get("active", false) == true;
    }

    // --- Other Collections ---
    
    // Testimonials Collection
    match /testimonials/{testimonialId} {
      allow write: if isAdmin();
      allow read: if isAdmin() || resource.data.visible == true;
    }
    match /testimonials {
      // Public users can only list testimonials that are marked as visible.
      allow list: if isAdmin() || request.query.where.get("visible", false) == true;
    }

    // Quote Requests (From Public Form)
    match /quote_requests/{quoteRequestId} {
      // Allow anyone to create a quote request, but only admins to read/update/delete.
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
    
    // Quotes (Admin-Generated)
    match /quotes/{quoteId} {
      allow read, write: if isAdmin();
    }
     match /quotes {
      allow list: if isAdmin();
    }


    // Admin Roles (Admin Only)
    match /roles_admin/{uid} {
      allow read, write: if isAdmin();
    }
  }
}
