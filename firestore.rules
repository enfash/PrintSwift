/**
 * @fileoverview Firestore Security Rules for a printing service application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model where only users
 * designated as "admins" have CRUD access to product categories, products,
 * and quote requests. Admin status is determined by the existence of a
 * document in the `/roles_admin/{uid}` collection.
 *
 * Data Structure:
 * - `/roles_admin/{uid}`:  Admin user IDs. Existence of a document grants admin role.
 * - `/product_categories/{productCategoryId}`: Stores product category information.
 * - `/products/{productId}`: Stores product information.
 * - `/quote_requests/{quoteRequestId}`: Stores customer quote requests.
 *
 * Key Security Decisions:
 * - Public Read, Admin Write: Product and category data is publicly readable to allow
 *   customers to browse the catalog. Write access is restricted to admins.
 * - Admin Role by Existence: Admin privileges are granted solely based on
 *   the existence of a document in `/roles_admin/{uid}`, not its content.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Determines if a user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Determines if the user is an admin.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Checks if the user is the owner of the specified document.
     * @param {string} userId - The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }


    /**
     * @description Rules for the /roles_admin/{uid} collection.
     * @path /roles_admin/{uid}
     * @allow (create) User with UID 'user123' creates a document at /roles_admin/user123 when authenticated as 'user123'.
     * @deny (create) User with UID 'user123' tries to create a document at /roles_admin/anotherUser when authenticated as 'user123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /roles_admin/{uid} {
      allow get: if false; // No one should be able to read admin user ids

      // Only the user themselves can create their admin role.
      allow create: if isOwner(uid);
      allow update: if false; // Nobody should be able to update
      allow delete: if false; // Nobody should be able to delete
      allow list: if false; // prevent listing of admin user ids
    }

    /**
     * @description Rules for the /product_categories/{productCategoryId} collection.
     * @path /product_categories/{productCategoryId}
     * @allow (get) Any user can read product categories.
     * @allow (create) An admin user creates a new product category.
     * @deny (create) A non-admin user attempts to create a product category.
     * @principle Public read access for catalog, admin-only for writes.
     */
    match /product_categories/{productCategoryId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /products/{productId} collection.
     * @path /products/{productId}
     * @allow (get) Any user can read products.
     * @allow (create) An admin user creates a new product.
     * @deny (create) A non-admin user attempts to create a product.
     * @principle Public read access for catalog, admin-only for writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Rules for the /quote_requests/{quoteRequestId} collection.
     * @path /quote_requests/{quoteRequestId}
     * @allow (create) Any user can submit a quote request.
     * @allow (get) An admin user retrieves a quote request.
     * @deny (update) No one can update a quote request after submission.
     * @principle Allows public submission, but viewing is restricted to admins.
     */
    match /quote_requests/{quoteRequestId} {
      allow get, list: if isAdmin();
      allow create: if true; // Allow anyone to create a quote request
      allow update, delete: if false;
    }
  }
}
