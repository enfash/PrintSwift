rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      // User must have a verified email and an admin role document.
      return request.auth.token.email_verified == true && 
             exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    // --- Default Security Rule (Deny All by Default) ---
    match /{path=**} {
        allow read, write: if false;
    }

    // --- Public Read Collections ---
    
    // Product Categories Collection
    match /product_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /product_categories {
      allow list: if true;
    }
    
    // Products Collection
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /products {
      allow list: if true;
    }

    // --- Other Collections ---
    
    // Testimonials Collection
    match /testimonials/{testimonialId} {
      allow write: if isAdmin();
      allow read: if isAdmin() || resource.data.visible == true;
    }
    match /testimonials {
      allow list: if isAdmin();
    }

    // Quote Requests (Admin Only)
    match /quote_requests/{quoteRequestId} {
      allow read, write: if isAdmin();
    }

    // Admin Roles (Admin Only)
    match /roles_admin/{uid} {
      allow read, write: if isAdmin();
    }
  }
}
